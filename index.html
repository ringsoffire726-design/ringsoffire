<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ring's of Fire - Esports League</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;600;700;800;900&family=Rajdhani:wght@300;400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Rajdhani', sans-serif; font-weight: 500; background-color: #020617; color: #e2e8f0; }
        .font-display { font-family: 'Orbitron', sans-serif; letter-spacing: 0.05em; }
        .font-mono { font-family: 'Share Tech Mono', monospace; }
        
        /* --- CYBERPUNK EFFECTS --- */
        .scanlines {
            position: fixed; left: 0; top: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.1) 50%, rgba(0,0,0,0.1));
            background-size: 100% 4px; opacity: 0.15;
        }
        .cyber-grid-bg {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 0;
            background-image: linear-gradient(rgba(6, 182, 212, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(6, 182, 212, 0.1) 1px, transparent 1px);
            background-size: 50px 50px; background-position: center center;
            mask-image: radial-gradient(circle at 50% 50%, black, transparent 80%);
            transform: perspective(500px) rotateX(20deg) scale(1.2);
            animation: gridMove 20s linear infinite; pointer-events: none;
        }
        @keyframes gridMove { 0% { background-position: 0 0; } 100% { background-position: 0 100px; } }

        .glitch-text { position: relative; color: white; }
        .glitch-text::before, .glitch-text::after { content: attr(data-text); position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .glitch-text::before { left: 2px; text-shadow: -1px 0 #ff00c1; clip: rect(44px, 450px, 56px, 0); animation: glitch-anim 5s infinite linear alternate-reverse; }
        .glitch-text::after { left: -2px; text-shadow: -1px 0 #00fff9; clip: rect(44px, 450px, 56px, 0); animation: glitch-anim2 5s infinite linear alternate-reverse; }
        @keyframes glitch-anim { 0% { clip: rect(14px, 9999px, 127px, 0); } 100% { clip: rect(86px, 9999px, 18px, 0); } }
        @keyframes glitch-anim2 { 0% { clip: rect(129px, 9999px, 36px, 0); } 100% { clip: rect(4px, 9999px, 9px, 0); } }

        .glass-card {
            background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; overflow: hidden;
        }
        .glass-card:hover { transform: translateY(-5px) scale(1.01); border-color: rgba(6, 182, 212, 0.5); box-shadow: 0 0 20px rgba(6, 182, 212, 0.2), inset 0 0 10px rgba(6, 182, 212, 0.1); }
        .glass-panel { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3); }
        .corner-bracket { position: absolute; width: 15px; height: 15px; border-color: rgba(255,255,255,0.3); transition: all 0.3s ease; pointer-events: none; }
        .group:hover .corner-bracket { width: 25px; height: 25px; border-color: #22d3ee; }
        
        .animate-scroll-left { animation: scroll-left 20s linear infinite; }
        @keyframes scroll-left { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        .animate-fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-pulse-fast { animation: pulse-fast 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse-fast { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(15, 23, 42, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #0891b2; border-radius: 10px; }
        input, select, button, textarea { font-family: 'Rajdhani', sans-serif; font-weight: 600; font-size: 16px !important; }
        h1, h2, h3, h4 { font-family: 'Orbitron', sans-serif; }
    </style>
</head>
<body class="bg-slate-950 text-slate-200 overflow-x-hidden">
    <div class="scanlines"></div>
    <div class="cyber-grid-bg"></div>
    <div id="root"></div>

    <!-- Application Logic -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useMemo } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, doc, setDoc, onSnapshot, serverTimestamp, arrayUnion, deleteDoc, increment, query, where } from 'https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js';
        import { Trophy, Gamepad2, Users, Calendar, CheckCircle, Plus, Trash2, LogOut, Shield, User, X, Lock, Key, Edit3, Crosshair, Award, History, Zap, QrCode, AlertTriangle, Check, Flame, Timer, AlertOctagon, Info, Pause, PlayCircle, Wallet, Smartphone, ShieldCheck, Loader2, ChevronRight, Megaphone, Coins, Save, MinusCircle, Pencil, Instagram, Mail, LogIn, UserPlus, Bell, Send, Share2, ArrowLeft, Archive, CreditCard } from 'https://esm.sh/lucide-react@0.292.0';

        const firebaseConfig = { apiKey: "AIzaSyA6h78d692c8B86bY9VdStoHxw-RXgKfBE", authDomain: "rings-of-fire-2.firebaseapp.com", projectId: "rings-of-fire-2", storageBucket: "rings-of-fire-2.firebasestorage.app", messagingSenderId: "53125558154", appId: "1:53125558154:web:4fa473df9d422ad48de273", measurementId: "G-JVJJB1SWHF" };
        let app, auth, db; try { app = initializeApp(firebaseConfig); auth = getAuth(app); db = getFirestore(app); } catch (e) { console.error(e); }

        const getTournamentCollection = () => db ? collection(db, 'tournaments') : null;
        const getTournamentDoc = (id) => db ? doc(db, 'tournaments', id) : null;
        const getSettingsDoc = (docName) => db ? doc(db, 'appSettings', docName) : null;
        const getNotificationsCollection = () => db ? collection(db, 'notifications') : null;
        const sendSystemNotification = async (target, title, message, type = 'info') => { try { const ref = getNotificationsCollection(); if(ref) await addDoc(ref, { target, title, message, type, createdAt: serverTimestamp(), readBy: [] }); } catch (e) {} };
        const formatDate = (isoString) => new Date(isoString).toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
        const formatTime = (isoString) => new Date(isoString).toLocaleTimeString('en-IN', { hour: 'numeric', minute: '2-digit', hour12: true });
        const DEFAULT_RULES = "1. Teaming with other squads results in immediate DQ.\n2. Hackers will be permanently banned.\n3. Room ID/Pass shared 10 mins before start.\n4. Screenshot your result for disputes.";

        // --- PAYMENT CONSTANTS ---
        const PAYOUT_UPI = "7042368784@pthdfc";
        const PAYOUT_NAME = "Fardeen";

        // --- COMPONENTS ---
        const CountdownTimer = ({ targetDate }) => {
          const [timeLeft, setTimeLeft] = useState({});
          useEffect(() => { 
              const tick = () => { const diff = +new Date(targetDate) - +new Date(); if (diff > 0) setTimeLeft({ d: Math.floor(diff / (1000 * 60 * 60 * 24)), h: Math.floor((diff / (1000 * 60 * 60)) % 24), m: Math.floor((diff / 1000 / 60) % 60), s: Math.floor((diff / 1000) % 60) }); else setTimeLeft({}); };
              tick(); const timer = setInterval(tick, 1000); return () => clearInterval(timer); 
          }, [targetDate]);
          if (Object.keys(timeLeft).length === 0) return <span className="text-emerald-400 font-bold animate-pulse font-mono tracking-widest">LIVE NOW</span>;
          return <div className="flex items-center gap-1 font-mono text-cyan-400 bg-cyan-950/30 px-2 py-0.5 rounded border border-cyan-500/30 shadow-[0_0_10px_rgba(6,182,212,0.2)]">{timeLeft.d > 0 && <span>{timeLeft.d}d</span>}<span>{String(timeLeft.h).padStart(2,'0')}h</span>:<span>{String(timeLeft.m).padStart(2,'0')}m</span>:<span>{String(timeLeft.s).padStart(2,'0')}s</span></div>;
        };

        const PaymentTimer = ({ initialSeconds, onExpire }) => {
            const [seconds, setSeconds] = useState(initialSeconds);
            useEffect(() => { if (seconds > 0) { const timer = setTimeout(() => setSeconds(seconds - 1), 1000); return () => clearTimeout(timer); } else { onExpire(); } }, [seconds]);
            const mins = Math.floor(seconds / 60); const secs = seconds % 60;
            return <span className="font-mono text-yellow-400">{mins}:{secs.toString().padStart(2, '0')}</span>;
        };

        const NewsTicker = ({ newsItems }) => {
            const items = newsItems && newsItems.length > 0 ? newsItems : ["Welcome to Ring's of Fire!", "Compete. Win. Earn."];
            return (
                <div className="bg-black/80 border-b border-cyan-500/30 h-9 flex items-center overflow-hidden relative z-50 backdrop-blur-md">
                    <div className="absolute left-0 z-10 bg-cyan-600 text-black px-3 h-full flex items-center font-display font-bold text-xs skew-x-[-10deg] ml-[-10px] pl-5 shadow-[0_0_15px_cyan]">NEWS FEED</div>
                    <div className="whitespace-nowrap animate-scroll-left flex gap-12 items-center text-xs text-cyan-100 font-mono w-full opacity-90">
                        {[...items, ...items, ...items].map((item, i) => <span key={i} className="flex items-center gap-2"><span className="text-cyan-500">///</span> {item}</span>)}
                    </div>
                </div>
            );
        };

        const NotificationCenter = ({ notifications }) => {
            const [isOpen, setIsOpen] = useState(false);
            return (
                <div className="relative z-50">
                    <button onClick={() => setIsOpen(!isOpen)} className="relative p-2 text-cyan-400 hover:text-white transition-colors group">
                        <Bell size={20} className="group-hover:drop-shadow-[0_0_5px_cyan] transition-all"/>
                        {notifications.length > 0 && <span className="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>}
                    </button>
                    {isOpen && (
                        <>
                            <div className="fixed inset-0" onClick={() => setIsOpen(false)}></div>
                            <div className="absolute right-0 mt-3 w-80 bg-slate-900/95 border border-cyan-500/30 rounded-xl shadow-[0_0_30px_rgba(6,182,212,0.15)] backdrop-blur-xl overflow-hidden animate-fade-in-up z-50">
                                <div className="p-3 border-b border-cyan-500/20 bg-cyan-950/30 flex justify-between items-center"><h4 className="font-display font-bold text-cyan-100 text-sm">SYSTEM LOGS</h4><span className="text-[10px] bg-cyan-500/20 text-cyan-400 px-2 py-0.5 rounded-sm font-mono border border-cyan-500/30">{notifications.length} NEW</span></div>
                                <div className="max-h-64 overflow-y-auto custom-scrollbar p-1">
                                    {notifications.length === 0 ? <div className="p-4 text-center text-slate-500 text-xs font-mono">NO NEW DATA</div> : notifications.map((note, i) => (
                                        <div key={i} className="p-3 mb-1 rounded border border-white/5 bg-white/5 hover:bg-white/10 transition-colors">
                                            <div className="flex justify-between mb-1"><span className={`font-bold text-xs ${note.type==='warning'?'text-yellow-400':'text-cyan-400'}`}>{note.title}</span><span className="text-[9px] text-slate-500 font-mono">{note.createdAt ? formatTime(note.createdAt.toDate()) : 'NOW'}</span></div>
                                            <p className="text-xs text-slate-300 leading-snug font-mono opacity-80">{note.message}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </>
                    )}
                </div>
            );
        };

        const ModalWrapper = ({ children, title, onClose, maxWidth="max-w-md" }) => (
            <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm animate-fade-in">
                <div className={`glass-panel p-1 rounded-2xl shadow-[0_0_50px_rgba(6,182,212,0.15)] w-full ${maxWidth} relative border border-cyan-500/30 overflow-hidden group`}>
                    <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-cyan-500 to-transparent opacity-50 group-hover:opacity-100 transition-opacity"></div>
                    <div className="bg-slate-950/90 p-6 md:p-8 rounded-xl h-full relative max-h-[90vh] overflow-y-auto custom-scrollbar">
                        {onClose && <button onClick={onClose} className="absolute top-4 right-4 text-slate-500 hover:text-white transition-colors"><X size={20}/></button>}
                        {title && <h3 className="text-xl font-display font-bold text-white mb-6 text-center uppercase tracking-wider glitch-text" data-text={title}>{title}</h3>}
                        {children}
                    </div>
                </div>
            </div>
        );

        function NewsEditorModal({ onClose, initialNews, showNotification }) {
            const [items, setItems] = useState(initialNews || []);
            const [newItem, setNewItem] = useState('');
            const addItem = (e) => { e.preventDefault(); if (newItem.trim()) { setItems([...items, newItem.trim()]); setNewItem(''); } };
            const removeItem = (index) => { setItems(items.filter((_, i) => i !== index)); };
            const saveNews = async () => {
                try {
                    const newsDoc = getSettingsDoc('news');
                    if(newsDoc) { await setDoc(newsDoc, { items }); showNotification("News Updated Successfully!"); onClose(); }
                } catch(e) { console.error(e); showNotification("Failed to save news", "error"); }
            };
            return (
                <ModalWrapper title="EDIT NEWS TICKER" onClose={onClose} maxWidth="max-w-lg">
                    <div className="space-y-3 mb-6"><form onSubmit={addItem} className="flex gap-2"><input className="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm outline-none focus:border-cyan-500 font-mono" placeholder="Type new announcement..." value={newItem} onChange={e=>setNewItem(e.target.value)}/><button className="bg-cyan-600 hover:bg-cyan-500 text-white p-2 rounded-lg"><Plus size={20}/></button></form><div className="max-h-60 overflow-y-auto custom-scrollbar space-y-2 bg-slate-900/50 p-2 rounded-lg">{items.length === 0 && <div className="text-slate-500 text-xs text-center py-4 font-mono">No news items.</div>}{items.map((item, i) => (<div key={i} className="flex justify-between items-center bg-slate-800 p-2 rounded border border-slate-700"><span className="text-sm text-slate-200 font-mono">{item}</span><button onClick={()=>removeItem(i)} className="text-red-400 hover:text-red-300 p-1"><MinusCircle size={16}/></button></div>))}</div></div>
                    <button onClick={saveNews} className="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl text-sm flex justify-center items-center gap-2 uppercase tracking-wider"><Save size={16}/> Save Changes</button>
                </ModalWrapper>
            );
        }

        function BroadcastModal({ onClose, showNotification }) {
            const [msg, setMsg] = useState('');
            const [title, setTitle] = useState('');
            const [sending, setSending] = useState(false);
            const handleSend = async (e) => { e.preventDefault(); setSending(true); try { await sendSystemNotification('all', title, msg, 'info'); showNotification('Broadcast Sent Successfully'); onClose(); } catch(e) { console.error(e); showNotification('Failed to send', 'error'); } finally { setSending(false); } };
            return (
                <ModalWrapper title="SEND BROADCAST" onClose={onClose} maxWidth="max-w-lg">
                    <p className="text-xs text-slate-400 mb-4 font-mono">This message will be sent to ALL registered users instantly.</p>
                    <form onSubmit={handleSend} className="space-y-4"><input required className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm outline-none focus:border-cyan-500 font-mono" placeholder="Title (e.g. Server Maintenance)" value={title} onChange={e=>setTitle(e.target.value)}/><textarea required className="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-white text-sm outline-none focus:border-cyan-500 h-24 resize-none custom-scrollbar font-mono" placeholder="Message body..." value={msg} onChange={e=>setMsg(e.target.value)}/><button disabled={sending} className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded-xl text-sm flex justify-center items-center gap-2 uppercase tracking-widest">{sending ? 'Sending...' : 'Send Broadcast'}</button></form>
                </ModalWrapper>
            );
        }

        function PaymentModal({ tournament, onClose, user, showNotification, onLoginRequest }) {
          const [step, setStep] = useState(1);
          const [loading, setLoading] = useState(false);
          const req = tournament.format === 'Squad' ? 4 : tournament.format === 'Duo' ? 2 : 1;
          const [form, setForm] = useState({ name: '', ign: '', txn: '', team: Array(req-1).fill(''), upiId: '', upiName: '' });
          const [autoCloseTimer, setAutoCloseTimer] = useState(5);

          // Generated UPI String
          const upiString = `upi://pay?pa=${PAYOUT_UPI}&pn=${encodeURIComponent(PAYOUT_NAME)}&am=${tournament.entryFee}&cu=INR`;
          // Dynamic QR Generation API
          const qrCodeApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiString)}`;

          useEffect(() => {
            let interval;
            if (step === 3) { interval = setInterval(() => { setAutoCloseTimer((prev) => { if (prev <= 1) { clearInterval(interval); onClose(); return 0; } return prev - 1; }); }, 1000); }
            return () => clearInterval(interval);
          }, [step, onClose]);

          // Robust check for non-anonymous user
          const isAuthenticated = user && !user.isAnonymous;

          // NEW: Check if user has already joined this tournament
          const isAlreadyJoined = useMemo(() => {
              if (!isAuthenticated || !tournament.participants) return false;
              return tournament.participants.some(p => p.userId === user.uid);
          }, [isAuthenticated, tournament, user]);

          const handleJoinSubmit = async (e, isFree = false) => {
              e.preventDefault(); setLoading(true); 
              
              // Double check duplicate prevention
              if (isAlreadyJoined) {
                  showNotification("You have already joined this tournament!", "warning");
                  onClose();
                  setLoading(false);
                  return;
              }
              
              try {
                const docRef = getTournamentDoc(tournament.id);
                if (docRef) { 
                    await updateDoc(docRef, { 
                        filledSlots: increment(req), 
                        participants: arrayUnion({ userId: user.uid, name: form.name, inGameName: form.ign, teammates: form.team, paymentId: isFree ? 'FREE-ENTRY' : form.txn, paymentVerified: isFree ? true : false, joinedAt: new Date().toISOString(), upiId: form.upiId, upiName: form.upiName }) 
                    }); 
                }
                if (isFree) { showNotification("Successfully Joined Tournament!"); onClose(); } 
                else { setStep(3); showNotification("Request Submitted"); await sendSystemNotification('admin', 'New Join Request', `${form.ign} requesting to join ${tournament.title}. Verify Payment: ${form.txn}`, 'warning'); }
              } catch(e) { console.error(e); alert("Error submitting. Please try again."); } finally { setLoading(false); }
          };
          
          if (!isAuthenticated) {
              return (
                <ModalWrapper title="JOIN THE ACTION" onClose={onClose}>
                    <div className="text-center p-4 animate-fade-in">
                        <div className="w-16 h-16 bg-cyan-500/20 rounded-full flex items-center justify-center mx-auto mb-4 border border-cyan-500/50"><User size={32} className="text-cyan-400"/></div>
                        <p className="text-slate-400 text-sm mb-6 font-mono">You need an operative account to register for <strong className="text-white">{tournament.title}</strong>.</p>
                        <button onClick={onLoginRequest} className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3.5 rounded-xl transition-all shadow-[0_0_15px_cyan] mb-3 font-display tracking-wide">LOGIN / CREATE ACCOUNT</button>
                        <button onClick={onClose} className="text-slate-500 hover:text-white text-sm font-mono">CANCEL</button>
                    </div>
                </ModalWrapper>
              );
          }

          // NEW: View for users who have already joined
          if (isAlreadyJoined) {
              return (
                <ModalWrapper title="MISSION STATUS" onClose={onClose}>
                    <div className="p-8 text-center animate-fade-in">
                        <div className="w-20 h-20 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-emerald-500/50 shadow-[0_0_20px_rgba(16,185,129,0.3)]">
                            <CheckCircle className="text-emerald-400 w-10 h-10"/>
                        </div>
                        <h3 className="text-2xl font-black text-white mb-2 font-display tracking-wider">ALREADY DEPLOYED</h3>
                        <p className="text-slate-400 text-sm mb-6 font-mono max-w-xs mx-auto">
                            Operative, you have already secured a slot in <strong className="text-white">{tournament.title}</strong>.
                        </p>
                        <div className="bg-slate-900/50 border border-slate-700 p-4 rounded-xl mb-6">
                            <div className="text-xs text-slate-500 uppercase font-bold mb-1">Status</div>
                            <div className="text-emerald-400 font-bold font-mono tracking-wider">CONFIRMED</div>
                        </div>
                        <button onClick={onClose} className="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3.5 rounded-xl text-sm font-mono transition-all border border-slate-600 hover:border-slate-500">
                            RETURN TO LOBBY
                        </button>
                    </div>
                </ModalWrapper>
              );
          }

          return (
            <ModalWrapper title={step===1?"REGISTRATION":step===2?"SECURE CHECKOUT":"STATUS REPORT"} onClose={step!==3?onClose:undefined} maxWidth="max-w-lg">
                {step === 1 ? (
                  <div className="animate-fade-in">
                      <div className="mb-4 text-xs font-mono text-cyan-400 border border-cyan-500/30 bg-cyan-950/30 p-2 rounded text-center">STEP 1: OPERATIVE DETAILS</div>
                      <form onSubmit={e => { e.preventDefault(); if (Number(tournament.entryFee) === 0) { handleJoinSubmit(e, true); } else { setStep(2); } }} className="space-y-4">
                        <div><label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">Real Name</label><input required className="w-full bg-slate-900 border border-slate-700 rounded px-4 py-3 text-white outline-none text-sm focus:border-cyan-500 font-mono" placeholder="Your Name" value={form.name} onChange={e=>setForm({...form, name:e.target.value})} /></div>
                        <div><label className="text-[10px] font-bold text-slate-500 uppercase mb-1 block">In-Game Name</label><input required className="w-full bg-slate-900 border border-slate-700 rounded px-4 py-3 text-white outline-none text-sm focus:border-cyan-500 font-mono" placeholder="IGN" value={form.ign} onChange={e=>setForm({...form, ign:e.target.value})} /></div>
                        {req > 1 && <div className="space-y-2"><label className="text-xs font-bold text-slate-500 uppercase">Teammates</label>{form.team.map((t,i)=><input key={i} required className="w-full bg-slate-900 border border-slate-700 rounded px-4 py-3 text-white outline-none text-sm font-mono" placeholder={`Teammate ${i+1}`} value={t} onChange={ev=>{const n=[...form.team]; n[i]=ev.target.value; setForm({...form, team:n})}} />)}</div>}
                        <div className="pt-4 border-t border-slate-800"><h4 className="text-sm font-bold text-cyan-400 mb-3 flex items-center gap-2 font-display"><Wallet size={16}/> PAYOUT INTEL</h4><div className="space-y-3"><div><label className="text-[10px] text-slate-500 font-bold uppercase block mb-1">UPI ID</label><input required className="w-full bg-slate-900 border border-slate-700 rounded px-4 py-3 text-white outline-none text-sm focus:border-cyan-500 font-mono" placeholder="e.g. user@upi" value={form.upiId} onChange={e=>setForm({...form, upiId:e.target.value})} /></div><div><label className="text-[10px] text-slate-500 font-bold uppercase block mb-1">Registered Name</label><input required className="w-full bg-slate-900 border border-slate-700 rounded px-4 py-3 text-white outline-none text-sm focus:border-cyan-500 font-mono" placeholder="e.g. John Doe" value={form.upiName} onChange={e=>setForm({...form, upiName:e.target.value})} /></div></div></div>
                        <button disabled={loading} className={`w-full text-white font-bold py-3 rounded mt-2 text-sm uppercase tracking-widest flex justify-center items-center gap-2 ${Number(tournament.entryFee) === 0 ? 'bg-emerald-600 hover:bg-emerald-500 shadow-[0_0_15px_emerald]' : 'bg-cyan-600 hover:bg-cyan-500 shadow-[0_0_15px_cyan]'}`}>{loading ? <Loader2 size={18} className="animate-spin"/> : (Number(tournament.entryFee) === 0 ? <CheckCircle size={18}/> : <ChevronRight size={18}/>)}{Number(tournament.entryFee) === 0 ? 'JOIN NOW (FREE)' : 'PROCEED TO PAYMENT'}</button>
                      </form>
                  </div>
                ) : step === 2 ? (
                  <div className="animate-fade-in">
                      <div className="bg-slate-900/50 p-3 flex justify-between items-center border border-slate-700 rounded mb-4"><div className="flex items-center gap-2"><div className="bg-blue-600/20 p-1.5 rounded text-blue-400 border border-blue-500/50"><ShieldCheck size={16}/></div><span className="text-slate-300 font-bold text-xs font-mono">SECURE CHANNEL</span></div><div className="text-right"><div className="text-[9px] text-slate-500 font-bold uppercase">SESSION</div><PaymentTimer initialSeconds={300} onExpire={onClose}/></div></div>
                      <div className="bg-slate-900 p-4 rounded border border-slate-700 mb-4"><div className="flex justify-between items-center mb-1"><span className="text-slate-500 text-[10px] uppercase font-bold">TOTAL FEE</span><span className="text-white font-black text-xl font-mono">₹{tournament.entryFee}.00</span></div></div>
                      <div className="space-y-3 mb-6">
                          <a href={upiString} className="block bg-white/5 hover:bg-white/10 border border-slate-700 p-3 rounded flex items-center gap-3 transition-all group"><div className="w-8 h-8 rounded bg-blue-500/20 flex items-center justify-center text-blue-400"><Smartphone size={16}/></div><div className="flex-1"><div className="text-white font-bold text-xs group-hover:text-blue-400 font-mono">PAY VIA APP</div></div><ChevronRight size={16} className="text-slate-500 group-hover:text-white"/></a>
                          <div className="bg-white/5 border border-slate-700 rounded overflow-hidden">
                            <div className="p-3 flex items-center gap-3 border-b border-slate-700"><div className="w-8 h-8 rounded bg-purple-500/20 flex items-center justify-center text-purple-400"><QrCode size={16}/></div><div className="flex-1"><div className="text-white font-bold text-xs font-mono">SCAN QR CODE</div></div></div>
                            <div className="p-4 flex flex-col items-center justify-center bg-white">
                                <img src={qrCodeApiUrl} alt="Payment QR" className="w-40 h-40 object-contain" />
                                <div className="text-black text-[10px] font-mono mt-1 font-bold">UPI: {PAYOUT_UPI}</div>
                            </div>
                          </div>
                      </div>
                      <div className="mt-4 p-4 rounded border border-blue-500/30 bg-blue-900/10">
                          <h4 className="text-blue-400 font-bold text-xs mb-2 font-mono">ENTER PAYMENT PROOF</h4>
                          <form onSubmit={(e) => handleJoinSubmit(e, false)} className="space-y-3"><div><label className="block text-[9px] font-bold text-slate-500 uppercase mb-1">UTR / Transaction ID (12 Digits)</label><input required minLength={12} className="w-full bg-black border border-slate-700 rounded px-3 py-2 text-white outline-none text-xs focus:border-blue-500 font-mono placeholder:text-slate-700" placeholder="e.g. 324589120934" value={form.txn} onChange={e=>setForm({...form, txn:e.target.value})} /></div><button disabled={loading} className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded text-xs shadow-[0_0_15px_blue] transition-all uppercase tracking-widest">{loading ? <Loader2 size={14} className="animate-spin mx-auto"/> : 'SUBMIT FOR VERIFICATION'}</button></form>
                      </div>
                  </div>
                ) : (
                  <div className="p-6 text-center animate-fade-in">
                      <div className="w-16 h-16 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4 animate-bounce border border-emerald-500/50"><CheckCircle className="text-emerald-400 w-8 h-8"/></div>
                      <h3 className="text-xl font-black text-white mb-2 font-display tracking-wider">REQUEST SUBMITTED</h3>
                      <div className="bg-emerald-900/20 border border-emerald-500/30 rounded p-4 mb-4"><p className="text-emerald-200 text-xs font-mono leading-relaxed">Admin is verifying payment.</p><p className="text-white font-bold text-sm mt-1 animate-pulse font-mono">ETA: 5-10 MINUTES</p></div>
                      <p className="text-slate-500 text-[10px] mb-1 font-mono">AUTO-CLOSING IN</p><div className="text-2xl font-mono font-bold text-white mb-4">{autoCloseTimer}s</div>
                      <button onClick={onClose} className="w-full bg-slate-800 hover:bg-slate-700 text-white py-2 rounded text-xs font-bold font-mono">RETURN TO LOBBY</button>
                  </div>
                )}
            </ModalWrapper>
          );
        }

        function CreateTournamentForm({ onComplete, userId, showNotification }) {
          const [loading, setLoading] = useState(false);
          const [formData, setFormData] = useState({ game: 'Free Fire', format: 'Solo', title: '', map: 'Bermuda', date: '', time: '', entryFee: 0, prizePool: 0, totalSlots: 48, rules: DEFAULT_RULES, announcement: '' });
          const handleSubmit = async (e) => {
            e.preventDefault(); setLoading(true);
            try {
              if (!formData.date || !formData.time) throw new Error("Please select a valid date and time.");
              const dateTime = new Date(`${formData.date}T${formData.time}`);
              if (isNaN(dateTime.getTime())) throw new Error("Invalid date format.");
              const collectionRef = getTournamentCollection();
              if (!collectionRef) throw new Error("Database not ready.");
              await addDoc(collectionRef, { ...formData, entryFee: Number(formData.entryFee), prizePool: Number(formData.prizePool), totalSlots: Number(formData.totalSlots), filledSlots: 0, participants: [], hostId: userId || 'unknown', roomId: '', roomPassword: '', status: 'upcoming', registrationOpen: true, winner: '', createdAt: serverTimestamp(), dateTime: dateTime.toISOString() });
              onComplete();
            } catch (error) { console.error(error); showNotification(error.message || "Failed", "error"); } finally { setLoading(false); }
          };
          return (
            <div className="glass-panel p-6 rounded-2xl border border-cyan-500/30 relative overflow-hidden">
              <div className="absolute top-0 left-0 w-1 h-full bg-cyan-500"></div>
              <h3 className="text-lg font-bold text-white flex items-center gap-2 font-display mb-6"><Zap size={20} className="text-cyan-400"/> INITIATE NEW EVENT</h3>
              <form onSubmit={handleSubmit} className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div><label className="block text-cyan-400 text-[10px] font-bold mb-1 font-mono">GAME PROTOCOL</label><select className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-cyan-500 outline-none" value={formData.game} onChange={e => setFormData({...formData, game: e.target.value})}><option>Free Fire</option><option>PUBG Mobile</option><option>BGMI</option><option>COD Mobile</option></select></div>
                  <div><label className="block text-cyan-400 text-[10px] font-bold mb-1 font-mono">SQUAD SIZE</label><select className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-cyan-500 outline-none" value={formData.format} onChange={e => setFormData({...formData, format: e.target.value})}><option>Solo</option><option>Duo</option><option>Squad</option></select></div>
                  <div><label className="block text-cyan-400 text-[10px] font-bold mb-1 font-mono">TERRAIN MAP</label><input required className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-cyan-500 outline-none" placeholder="e.g. Bermuda" value={formData.map} onChange={e => setFormData({...formData, map: e.target.value})} /></div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4"><input required type="text" className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-cyan-500 outline-none" placeholder="Event Designation (Title)" value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} /><div className="flex gap-2"><input required type="date" className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-cyan-500 outline-none" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} /><input required type="time" className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-cyan-500 outline-none" value={formData.time} onChange={e => setFormData({...formData, time: e.target.value})} /></div></div>
                <div className="grid grid-cols-3 gap-3"><input required type="number" className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-cyan-500 outline-none" placeholder="Entry Fee" value={formData.entryFee} onChange={e => setFormData({...formData, entryFee: e.target.value})} /><input required type="number" className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-cyan-500 outline-none" placeholder="Pool Prize" value={formData.prizePool} onChange={e => setFormData({...formData, prizePool: e.target.value})} /><input required type="number" className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-cyan-500 outline-none" placeholder="Max Units" value={formData.totalSlots} onChange={e => setFormData({...formData, totalSlots: e.target.value})} /></div>
                <div><label className="block text-cyan-400 text-[10px] font-bold mb-1 font-mono">ENGAGEMENT RULES</label><textarea className="w-full bg-slate-900 border border-slate-700 rounded px-3 py-2 text-white text-sm focus:border-cyan-500 outline-none h-20 resize-none custom-scrollbar" value={formData.rules} onChange={e => setFormData({...formData, rules: e.target.value})} /></div>
                <button disabled={loading} className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded uppercase tracking-widest text-sm transition-all hover:shadow-[0_0_15px_cyan]">{loading ? 'INITIALIZING...' : 'LAUNCH EVENT'}</button>
              </form>
            </div>
          );
        }

        function AdminTournamentCard({ data, showNotification }) {
          const [expanded, setExpanded] = useState(false);
          const [editing, setEditing] = useState(false);
          const [resultModal, setResultModal] = useState(false);
          const [room, setRoom] = useState({ id: data.roomId || '', pass: data.roomPassword || '' });
          const [winner, setWinner] = useState(data.winner || '');
          const [isEditingDetails, setIsEditingDetails] = useState(false);
          const [editForm, setEditForm] = useState({});

          useEffect(() => { if (data.winner) setWinner(data.winner); }, [data.winner]);

          const toggleRegistration = async () => { const docRef = getTournamentDoc(data.id); if (docRef) { await updateDoc(docRef, { registrationOpen: !data.registrationOpen }); showNotification(!data.registrationOpen ? "Registration Resumed" : "Registration Paused"); } };
          const updateRoom = async (e) => { e.preventDefault(); const docRef = getTournamentDoc(data.id); if (docRef) { await updateDoc(docRef, { roomId: room.id, roomPassword: room.pass }); setEditing(false); showNotification("Room Updated"); if (room.id && room.pass) { await sendSystemNotification('all', 'Room ID Updated', `Room details for ${data.title} are now available!`); } } };
          const verifyUser = async (uid) => { const docRef = getTournamentDoc(data.id); if (docRef) { await updateDoc(docRef, { participants: data.participants.map(p => p.userId === uid ? { ...p, paymentVerified: true } : p) }); showNotification("Verified"); } };
          const removeUser = async (uid) => { const docRef = getTournamentDoc(data.id); if (docRef) { await updateDoc(docRef, { participants: data.participants.filter(p => p.userId !== uid), filledSlots: increment(-(data.format === 'Squad' ? 4 : data.format === 'Duo' ? 2 : 1)) }); showNotification("Removed"); } };
          const saveWinner = async () => { const docRef = getTournamentDoc(data.id); if (docRef) { await updateDoc(docRef, { status: 'completed', winner }); setResultModal(false); showNotification("Winner Declared"); } };
          const deleteT = async () => { if(confirm("Delete tournament?")) { const docRef = getTournamentDoc(data.id); if(docRef) await deleteDoc(docRef); } };
          const endTournament = async () => { if(confirm("Close tournament?")) { const docRef = getTournamentDoc(data.id); if(docRef) { await updateDoc(docRef, { status: 'completed' }); showNotification("Tournament Closed"); } } };
          
          const startEditingDetails = () => {
            const dateObj = new Date(data.dateTime);
            const dateStr = dateObj.toISOString().split('T')[0];
            const timeStr = dateObj.toTimeString().slice(0, 5);
            setEditForm({ title: data.title, game: data.game, map: data.map, entryFee: data.entryFee, prizePool: data.prizePool, totalSlots: data.totalSlots, rules: data.rules || DEFAULT_RULES, announcement: data.announcement || '', date: dateStr, time: timeStr });
            setIsEditingDetails(true);
          };
          const handleSaveDetails = async (e) => {
              e.preventDefault();
              try {
                  const dateTime = new Date(`${editForm.date}T${editForm.time}`);
                  if (isNaN(dateTime.getTime())) throw new Error("Invalid Date/Time");
                  const docRef = getTournamentDoc(data.id);
                  await updateDoc(docRef, { title: editForm.title, game: editForm.title, map: editForm.map, entryFee: Number(editForm.entryFee), prizePool: Number(editForm.prizePool), totalSlots: Number(editForm.totalSlots), rules: editForm.rules, announcement: editForm.announcement, dateTime: dateTime.toISOString() });
                  setIsEditingDetails(false); showNotification("Tournament Updated Successfully");
              } catch(e) { console.error(e); alert(e.message); }
          };

          if (isEditingDetails) {
             return (
                 <div className="glass-card rounded-xl p-6 border border-cyan-500/50 mb-4 bg-slate-900/90">
                     <h4 className="text-white font-bold mb-4 flex items-center gap-2 font-display"><Pencil size={16} className="text-cyan-400" /> EDIT PARAMETERS</h4>
                     <form onSubmit={handleSaveDetails} className="space-y-3">
                        <input className="w-full bg-black border border-slate-600 rounded p-2 text-white text-sm font-mono" value={editForm.title} onChange={e=>setEditForm({...editForm, title:e.target.value})} placeholder="Title" required/>
                        <div className="grid grid-cols-2 gap-2"><input className="bg-black border border-slate-600 rounded p-2 text-white text-sm font-mono" value={editForm.date} onChange={e=>setEditForm({...editForm, date:e.target.value})} type="date" required/><input className="bg-black border border-slate-600 rounded p-2 text-white text-sm font-mono" value={editForm.time} onChange={e=>setEditForm({...editForm, time:e.target.value})} type="time" required/></div>
                        <div className="grid grid-cols-3 gap-2"><input className="bg-black border border-slate-600 rounded p-2 text-white text-sm font-mono" value={editForm.entryFee} onChange={e=>setEditForm({...editForm, entryFee:e.target.value})} type="number" placeholder="Fee" required/><input className="bg-black border border-slate-600 rounded p-2 text-white text-sm font-mono" value={editForm.prizePool} onChange={e=>setEditForm({...editForm, prizePool:e.target.value})} type="number" placeholder="Prize" required/><input className="bg-black border border-slate-600 rounded p-2 text-white text-sm font-mono" value={editForm.totalSlots} onChange={e=>setEditForm({...editForm, totalSlots:e.target.value})} type="number" placeholder="Slots" required/></div>
                        <input className="w-full bg-black border border-slate-600 rounded p-2 text-white text-sm font-mono" value={editForm.map} onChange={e=>setEditForm({...editForm, map:e.target.value})} placeholder="Map" required/>
                        <textarea className="w-full bg-black border border-slate-600 rounded p-2 text-white text-sm h-20 resize-none custom-scrollbar font-mono" value={editForm.rules} onChange={e=>setEditForm({...editForm, rules:e.target.value})} placeholder="Rules" />
                        <div><label className="block text-cyan-400 text-[10px] font-bold mb-1 font-mono">MATCH NOTICE</label><input className="w-full bg-black border border-slate-600 rounded p-2 text-white text-sm font-mono" value={editForm.announcement} onChange={e=>setEditForm({...editForm, announcement:e.target.value})} placeholder="e.g. Room ID delayed by 10 mins" /></div>
                        <div className="flex gap-2 justify-end pt-2"><button type="button" onClick={()=>setIsEditingDetails(false)} className="px-4 py-2 text-xs text-slate-400 hover:text-white bg-slate-800 rounded">CANCEL</button><button type="submit" className="px-4 py-2 text-xs bg-cyan-600 text-white rounded font-bold hover:bg-cyan-500">SAVE CHANGES</button></div>
                     </form>
                 </div>
             );
          }

          const teamSize = data.format === 'Squad' ? 4 : data.format === 'Duo' ? 2 : 1;
          const calculatedFilled = (data.participants?.length || 0) * teamSize;

          return (
            <div className={`glass-card rounded-xl overflow-hidden mb-4 border-l-4 ${data.status === 'completed' ? 'border-l-slate-600 opacity-70' : 'border-l-cyan-500'}`}>
              <div className="p-4 flex flex-col md:flex-row gap-4 justify-between items-start md:items-center bg-slate-900/40">
                <div className="flex-1">
                  <div className="flex gap-2 mb-2"><span className="text-[10px] font-bold bg-cyan-900/50 text-cyan-400 px-2 py-0.5 rounded border border-cyan-500/30">{data.game}</span><span className="text-[10px] font-bold bg-slate-800 text-slate-300 px-2 py-0.5 rounded">{data.format}</span></div>
                  <h3 className="text-lg font-display font-bold text-white flex items-center gap-2">{data.title} <button onClick={startEditingDetails} className="text-slate-500 hover:text-cyan-400 transition-colors"><Pencil size={14}/></button></h3>
                  <div className="text-xs text-slate-400 font-mono mt-1">Players: {calculatedFilled}/{data.totalSlots} | Prize: ₹{data.prizePool}</div>
                </div>
                <div className="flex gap-2 flex-wrap">
                    <button onClick={() => setResultModal(true)} className="p-2 text-yellow-400 bg-yellow-500/10 hover:bg-yellow-500/20 rounded border border-yellow-500/30" title="Winner"><Award size={18}/></button>
                    <button onClick={endTournament} className="p-2 text-red-400 bg-red-500/10 hover:bg-red-500/20 rounded border border-red-500/30" title="End"><Archive size={18}/></button>
                    <button onClick={() => setExpanded(!expanded)} className="p-2 text-slate-300 bg-slate-700/50 hover:bg-slate-700 rounded border border-slate-600" title="Players"><Users size={18}/></button>
                    <button onClick={deleteT} className="p-2 text-red-500 hover:bg-red-900/20 rounded" title="Delete"><Trash2 size={18}/></button>
                </div>
              </div>
              {expanded && (
                <div className="bg-black/40 p-4 grid grid-cols-1 md:grid-cols-2 gap-4 border-t border-white/5">
                  <div className="bg-slate-900/50 p-4 rounded border border-white/10">
                      <div className="flex justify-between mb-2"><h4 className="text-xs font-bold text-cyan-400 font-mono">ROOM DATA</h4><button onClick={() => setEditing(true)} className="text-xs text-slate-400 hover:text-white"><Edit3 size={12}/></button></div>
                      {editing ? (
                          <form onSubmit={updateRoom} className="space-y-2"><input className="w-full bg-black border border-slate-700 rounded px-2 py-1 text-xs text-white font-mono" value={room.id} onChange={e=>setRoom({...room, id:e.target.value})} placeholder="ID"/><input className="w-full bg-black border border-slate-700 rounded px-2 py-1 text-xs text-white font-mono" value={room.pass} onChange={e=>setRoom({...room, pass:e.target.value})} placeholder="Pass"/><button className="bg-cyan-600 text-white px-2 py-1 rounded text-xs w-full">SAVE</button></form>
                      ) : (
                          <div className="space-y-1 text-xs font-mono"><div className="flex justify-between text-slate-400"><span>ID:</span> <span className="text-white">{data.roomId || '--'}</span></div><div className="flex justify-between text-slate-400"><span>PW:</span> <span className="text-white">{data.roomPassword || '--'}</span></div></div>
                      )}
                  </div>
                  <div>
                      <h4 className="text-xs font-bold text-slate-400 mb-2 font-mono">OPERATIVES ({data.participants?.length || 0})</h4>
                      <div className="space-y-1 max-h-40 overflow-y-auto custom-scrollbar">
                          {data.participants?.map((p, i) => (
                              <div key={i} className="p-2 rounded bg-white/5 flex flex-col gap-1">
                                  <div className="flex justify-between items-center">
                                      <div className="text-xs text-slate-300 font-mono">{p.inGameName} <span className="text-[10px] text-slate-500">({p.paymentId})</span></div>
                                      <div className="flex gap-1">{!p.paymentVerified && <button onClick={()=>verifyUser(p.userId)} className="text-emerald-400 hover:text-emerald-300"><Check size={14}/></button>}<button onClick={()=>removeUser(p.userId)} className="text-red-400 hover:text-red-300"><Trash2 size={14}/></button></div>
                                  </div>
                                  {(p.upiId || p.upiName) && (
                                      <div className="text-[10px] text-slate-500 border-t border-white/5 pt-1 mt-1">
                                          <span className="text-cyan-600 font-bold">PAYOUT:</span> <span className="select-all text-slate-400">{p.upiId}</span> | <span className="text-slate-400">{p.upiName}</span>
                                      </div>
                                  )}
                              </div>
                          ))}
                      </div>
                  </div>
                </div>
              )}
              {resultModal && (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm">
                    <div className="glass-panel p-6 rounded-xl w-full max-w-sm border border-yellow-500/30"><h3 className="text-lg font-bold text-yellow-400 mb-4 font-display">DECLARE VICTOR</h3><input className="w-full bg-slate-900 border border-yellow-500/30 rounded px-3 py-2 text-white mb-4 outline-none font-mono" placeholder="Winner Name" value={winner} onChange={e => setWinner(e.target.value)} /><div className="flex gap-2"><button onClick={saveWinner} className="flex-1 bg-yellow-600 text-black font-bold py-2 rounded text-sm">CONFIRM</button><button onClick={() => setResultModal(false)} className="flex-1 bg-slate-800 text-white py-2 rounded text-sm">CANCEL</button></div></div>
                </div>
              )}
            </div>
          );
        }

        function AdminPanel({ tournaments, showNotification, userId, news }) {
          const [view, setView] = useState('list');
          const [showNews, setShowNews] = useState(false);
          const [showBroadcast, setShowBroadcast] = useState(false);
          return (
            <div className="animate-fade-in">
              {showNews && <NewsEditorModal onClose={()=>setShowNews(false)} initialNews={news} showNotification={showNotification} />}
              {showBroadcast && <BroadcastModal onClose={()=>setShowBroadcast(false)} showNotification={showNotification} />}
              <div className="flex justify-between items-center mb-8">
                <h2 className="text-2xl font-display font-bold text-white flex items-center gap-2"><Shield className="text-cyan-500"/> COMMAND CENTER</h2>
                <div className="flex gap-2">
                    {view === 'list' && (<><button onClick={() => setShowBroadcast(true)} className="bg-cyan-900/50 border border-cyan-500/30 hover:bg-cyan-900/80 text-cyan-400 px-3 py-2 rounded flex items-center gap-2 font-bold transition-all text-xs font-mono"><Bell size={14}/> <span className="hidden md:inline">ALERT</span></button><button onClick={() => setShowNews(true)} className="bg-slate-800 hover:bg-slate-700 text-white px-3 py-2 rounded flex items-center gap-2 font-bold transition-all border border-slate-700 text-xs font-mono"><Megaphone size={14} className="text-yellow-400"/> <span className="hidden md:inline">NEWS</span></button></>)}
                    {view === 'list' ? <button onClick={() => setView('create')} className="bg-cyan-600 hover:bg-cyan-500 text-white px-4 py-2 rounded font-bold text-sm tracking-wider shadow-[0_0_15px_cyan] flex gap-2 items-center"><Plus size={16}/> DEPLOY EVENT</button> : <button onClick={() => setView('list')} className="text-slate-400 hover:text-white font-mono text-sm flex gap-2 items-center"><ArrowLeft size={16}/> ABORT</button>}
                </div>
              </div>
              {view === 'create' ? <CreateTournamentForm onComplete={() => { setView('list'); showNotification('Event Deployed'); }} userId={userId} showNotification={showNotification}/> : <div className="grid gap-4 animate-fade-in-up">{tournaments.map(t => <AdminTournamentCard key={t.id} data={t} showNotification={showNotification} />)}</div>}
            </div>
          );
        }

        function PlayerTournamentCard({ t, joined, verified, slotsLeft, percentFilled, isFull, setSelected }) {
            const [activeTab, setActiveTab] = useState('overview');
            const [now, setNow] = useState(Date.now());
            useEffect(() => { const interval = setInterval(() => setNow(Date.now()), 30000); return () => clearInterval(interval); }, []);
            
            const shareTournament = (e) => {
                e.stopPropagation();
                const msg = `🔥 *Join me in this Tournament!* 🔥\n\n🏆 *${t.title}*\n🎮 *Game:* ${t.game} (${t.format})\n💰 *Prize:* ₹${t.prizePool}\n📅 *Date:* ${formatDate(t.dateTime)} @ ${formatTime(t.dateTime)}\n\n👇 *Click here to Register:* 👇\nhttps://koindro.com/?tournament_id=${t.id}`;
                window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
            };

            // Logic to determine button text
            const joinButtonText = t.format === 'Solo' ? 'DEPLOY OPERATIVE' : 'DEPLOY SQUAD';

            return (
                <div className={`glass-card rounded-xl overflow-hidden flex flex-col h-full group relative border-t border-white/10 ${t.status==='completed'?'opacity-60 grayscale':''}`}>
                    <div className="absolute top-0 right-0 w-20 h-20 bg-cyan-500/20 blur-[50px] rounded-full pointer-events-none group-hover:bg-cyan-400/30 transition-all"></div>
                    <div className="p-4 pb-0 flex flex-col relative z-10">
                        <div className="flex justify-between items-start mb-2">
                            <span className="text-[10px] font-bold bg-slate-950 border border-cyan-500/30 text-cyan-400 px-2 py-1 rounded uppercase tracking-wider">{t.game}</span>
                            <button onClick={shareTournament} className="text-slate-400 hover:text-white p-1 rounded hover:bg-white/10 transition-colors"><Share2 size={16}/></button>
                        </div>
                        <h3 className="text-lg font-display font-bold text-white leading-tight mb-2 group-hover:text-cyan-300 transition-colors truncate">{t.title}</h3>
                        
                        <div className="flex border-b border-white/10 mt-2">
                            <button onClick={()=>setActiveTab('overview')} className={`flex-1 py-2 text-[10px] font-bold uppercase tracking-wider transition-colors ${activeTab==='overview' ? 'text-cyan-400 border-b-2 border-cyan-400 bg-cyan-950/20' : 'text-slate-500 hover:text-slate-300'}`}>Intel</button>
                            <button onClick={()=>setActiveTab('players')} className={`flex-1 py-2 text-[10px] font-bold uppercase tracking-wider transition-colors ${activeTab==='players' ? 'text-cyan-400 border-b-2 border-cyan-400 bg-cyan-950/20' : 'text-slate-500 hover:text-slate-300'}`}>{t.format === 'Solo' ? 'Players' : t.format + 's'}</button>
                            <button onClick={()=>setActiveTab('prizes')} className={`flex-1 py-2 text-[10px] font-bold uppercase tracking-wider transition-colors ${activeTab==='prizes' ? 'text-cyan-400 border-b-2 border-cyan-400 bg-cyan-950/20' : 'text-slate-500 hover:text-slate-300'}`}>Loot</button>
                            <button onClick={()=>setActiveTab('rules')} className={`flex-1 py-2 text-[10px] font-bold uppercase tracking-wider transition-colors ${activeTab==='rules' ? 'text-cyan-400 border-b-2 border-cyan-400 bg-cyan-950/20' : 'text-slate-500 hover:text-slate-300'}`}>Rules</button>
                        </div>
                    </div>

                    <div className="p-4 pt-3 flex-1 flex flex-col gap-3 text-xs text-slate-300 bg-slate-900/30">
                        {activeTab === 'overview' && (
                            <div className="animate-fade-in space-y-3">
                                <div className="flex justify-between text-xs font-mono text-slate-400">
                                    <span className="flex items-center gap-1"><Calendar size={12}/> {formatDate(t.dateTime)}</span>
                                    <span className="flex items-center gap-1"><Timer size={12}/> {formatTime(t.dateTime)}</span>
                                </div>
                                {t.announcement && <div className="bg-orange-500/10 border-l-2 border-orange-500 p-2 text-[10px] text-orange-200 font-mono">{t.announcement}</div>}
                                
                                <div className="mt-auto">
                                    <div className="flex justify-between items-end mb-2">
                                        <div><div className="text-[10px] text-slate-500 uppercase font-bold">Prize</div><div className="text-lg font-black text-yellow-400 font-mono">₹{t.prizePool}</div></div>
                                        <div className="text-right"><div className="text-[10px] text-slate-500 uppercase font-bold">Entry</div><div className="text-base font-bold text-white">{t.entryFee===0 ? <span className="text-emerald-400">FREE</span> : `₹${t.entryFee}`}</div></div>
                                    </div>
                                    <div className="flex justify-between text-[10px] font-mono text-cyan-400 mb-1"><span>CAPACITY</span><span>{slotsLeft} REMAINING</span></div>
                                    <div className="w-full bg-slate-800 h-1 rounded-full overflow-hidden mb-3"><div className="h-full bg-cyan-500 shadow-[0_0_5px_cyan]" style={{width:`${percentFilled}%`}}></div></div>
                                    
                                    {joined ? (
                                        <div className={`w-full py-2 rounded border ${verified ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-400' : 'bg-yellow-500/10 border-yellow-500/30 text-yellow-400'} text-center font-bold text-xs font-mono`}>{verified ? 'STATUS: CONFIRMED' : 'STATUS: PENDING'}</div>
                                    ) : isFull || t.status === 'completed' ? (
                                        <div className="w-full py-2 bg-slate-800 text-slate-500 text-center font-bold text-xs border border-white/5">SECTOR CLOSED</div>
                                    ) : !t.registrationOpen ? (
                                        <div className="w-full py-2 bg-slate-800 text-slate-500 text-center font-bold text-xs border border-white/5 flex items-center justify-center gap-2"><Pause size={14}/> PAUSED</div>
                                    ) : (
                                        <button onClick={()=>setSelected(t)} className="w-full bg-cyan-600 hover:bg-cyan-500 text-white py-2 rounded font-bold text-xs tracking-widest shadow-[0_0_10px_rgba(6,182,212,0.3)] hover:shadow-[0_0_20px_cyan] transition-all">{joinButtonText}</button>
                                    )}
                                </div>
                            </div>
                        )}
                        {activeTab === 'players' && (<div className="animate-fade-in h-32 overflow-y-auto custom-scrollbar"><div className="space-y-1">{t.participants?.length > 0 ? t.participants.map((p,i)=><div key={i} className="flex justify-between bg-white/5 p-1.5 rounded text-[10px] font-mono"><span className="text-white">{i+1}. {p.inGameName}</span><span className="text-slate-500">{p.name}</span></div>) : <div className="text-center text-slate-500 py-4 font-mono">NO OPERATIVES</div>}</div></div>)}
                        {activeTab === 'prizes' && (<div className="animate-fade-in text-center py-4"><Trophy size={32} className="mx-auto text-yellow-500 mb-2"/><div className="text-xl font-black text-yellow-400 font-mono">₹{t.prizePool}</div><div className="text-[10px] text-slate-500 mt-1 font-mono">WINNER TAKES ALL</div></div>)}
                        {activeTab === 'rules' && (<div className="animate-fade-in h-32 overflow-y-auto custom-scrollbar text-[10px] text-slate-400 font-mono whitespace-pre-wrap">{t.rules || "Standard engagement protocols apply."}</div>)}
                    </div>
                </div>
            );
        }

        function PlayerAuthModal({ onClose, onLogin, showNotification }) {
            const [isSignUp, setIsSignUp] = useState(false);
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleAuth = async (e) => {
                e.preventDefault(); setLoading(true); setError('');
                try {
                    if (isSignUp) await createUserWithEmailAndPassword(auth, email, password);
                    else await signInWithEmailAndPassword(auth, email, password);
                    showNotification("Access Granted", "success"); onLogin();
                } catch (err) { 
                    console.error("Login Error:", err.code, err.message); 
                    let msg = "Authentication Failed";
                    if (err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found' || err.code === 'auth/wrong-password') {
                        msg = "Invalid Email or Password";
                    } else if (err.code === 'auth/email-already-in-use') {
                        msg = "Email already in use";
                    } else if (err.code === 'auth/weak-password') {
                        msg = "Password too weak (min 6 chars)";
                    }
                    setError(msg); 
                } finally { setLoading(false); }
            };
            return (
                <ModalWrapper title={isSignUp ? "INITIATE_PROTOCOL" : "SYSTEM_LOGIN"} onClose={onClose}>
                    <form onSubmit={handleAuth} className="space-y-4">
                        <div className="space-y-2">
                            <div className="relative"><Mail size={16} className="absolute left-3 top-3.5 text-cyan-600"/><input type="email" placeholder="Email" className="w-full bg-slate-900 border border-slate-700 focus:border-cyan-500 rounded px-10 py-3 text-sm text-white outline-none transition-all font-mono placeholder:text-slate-600" value={email} onChange={e=>setEmail(e.target.value)} required/></div>
                            <div className="relative"><Key size={16} className="absolute left-3 top-3.5 text-cyan-600"/><input type="password" placeholder="Password" className="w-full bg-slate-900 border border-slate-700 focus:border-cyan-500 rounded px-10 py-3 text-sm text-white outline-none transition-all font-mono placeholder:text-slate-600" value={password} onChange={e=>setPassword(e.target.value)} required/></div>
                        </div>
                        {error && <div className="text-red-500 text-xs font-mono text-center mb-2 border border-red-500/30 bg-red-500/10 p-2 rounded">{error}</div>}
                        <button type="submit" disabled={loading} className="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-3 rounded uppercase tracking-widest text-sm transition-all hover:shadow-[0_0_20px_rgba(6,182,212,0.4)]">{loading ? 'PROCESSING...' : (isSignUp ? 'REGISTER' : 'LOGIN')}</button>
                        <div className="text-center"><button type="button" onClick={()=>setIsSignUp(!isSignUp)} className="text-xs text-cyan-400 hover:text-cyan-300 font-mono underline decoration-cyan-800 hover:decoration-cyan-400 underline-offset-4 transition-all">{isSignUp ? "Existing User? Login" : "New User? Register"}</button></div>
                    </form>
                </ModalWrapper>
            );
        }

        function AdminLoginModal({ onClose, onLogin, showNotification }) {
            const [creds, setCreds] = useState({ id: '', password: '' });
            const [error, setError] = useState('');
            const handleLogin = async (e) => { 
                e.preventDefault(); 
                if(creds.id === 'blackboom172' && creds.password === '1517') { 
                    try {
                        if(!auth.currentUser) await signInAnonymously(auth); 
                        showNotification('Admin Access Granted'); 
                        onLogin(); 
                    } catch (e) {
                        console.error("Admin Auth Failed", e);
                        setError("Database Connection Failed");
                    }
                } else { 
                    setError('ACCESS DENIED'); 
                    setTimeout(()=>setError(''), 2000); 
                } 
            };
            return (
                <ModalWrapper title="ORGANIZER_ACCESS" onClose={onClose}>
                    <form onSubmit={handleLogin} className="space-y-4">
                        <input type="text" placeholder="ID" className="w-full bg-slate-900 border border-slate-700 focus:border-red-500 rounded px-4 py-3 text-sm text-white outline-none font-mono" value={creds.id} onChange={e=>setCreds({...creds, id:e.target.value})}/>
                        <input type="password" placeholder="KEY" className="w-full bg-slate-900 border border-slate-700 focus:border-red-500 rounded px-4 py-3 text-sm text-white outline-none font-mono" value={creds.password} onChange={e=>setCreds({...creds, password:e.target.value})}/>
                        {error && <div className="text-red-500 font-mono text-xs text-center animate-pulse">{error}</div>}
                        <button className="w-full bg-red-600 hover:bg-red-500 text-white font-bold py-3 rounded uppercase tracking-widest text-sm hover:shadow-[0_0_20px_rgba(220,38,38,0.4)]">AUTHENTICATE</button>
                    </form>
                </ModalWrapper>
            );
        }

        function PlayerProfile({ userId, userEmail, tournaments, onBack }) {
            const myTournaments = useMemo(() => { return tournaments.filter(t => t.participants && t.participants.some(p => p.userId === userId)); }, [tournaments, userId]);
            const stats = useMemo(() => {
                let played = myTournaments.length; let wins = 0; let earnings = 0;
                myTournaments.forEach(t => { const myData = t.participants.find(p => p.userId === userId); if (t.status === 'completed' && t.winner && myData && t.winner === myData.inGameName) { wins++; earnings += Number(t.prizePool) || 0; } });
                return { played, wins, earnings };
            }, [myTournaments, userId]);

            return (
                <div className="animate-fade-in">
                    <button onClick={onBack} className="text-slate-400 hover:text-white mb-6 flex gap-2 items-center text-sm font-bold tracking-wider"><ArrowLeft size={16}/> BACK TO BASE</button>
                    <div className="flex flex-col md:flex-row items-center gap-6 mb-8 bg-slate-900/50 p-6 rounded-2xl border border-cyan-500/20">
                        <div className="w-20 h-20 bg-gradient-to-br from-cyan-500 to-blue-600 rounded-full flex items-center justify-center shadow-[0_0_20px_rgba(6,182,212,0.4)] ring-4 ring-slate-900/50"><User size={40} className="text-white"/></div>
                        <div className="text-center md:text-left"><h2 className="text-2xl font-bold text-white font-display tracking-wide">OPERATIVE PROFILE</h2><p className="text-slate-400 text-sm font-mono">{userEmail || 'UNKNOWN AGENT'}</p></div>
                    </div>
                    <div className="grid grid-cols-3 gap-4 mb-8">
                        <div className="bg-slate-900/50 border border-slate-700 rounded-2xl p-4 flex flex-col items-center justify-center text-center group hover:border-cyan-500/50 transition-colors"><span className="text-slate-500 text-[10px] uppercase font-bold mb-1 font-display">Matches</span><span className="text-3xl font-black text-white font-mono group-hover:text-cyan-400 transition-colors">{stats.played}</span></div>
                        <div className="bg-slate-900/50 border border-slate-700 rounded-2xl p-4 flex flex-col items-center justify-center text-center group hover:border-emerald-500/50 transition-colors"><span className="text-slate-500 text-[10px] uppercase font-bold mb-1 font-display">Victories</span><span className="text-3xl font-black text-emerald-400 font-mono">{stats.wins}</span></div>
                        <div className="bg-gradient-to-br from-yellow-900/10 to-transparent border border-yellow-500/30 rounded-2xl p-4 flex flex-col items-center justify-center text-center relative overflow-hidden group hover:bg-yellow-900/20 transition-all"><span className="text-yellow-600 text-[10px] uppercase font-bold mb-1 font-display flex items-center gap-1">Earnings</span><span className="text-3xl font-black text-yellow-400 font-mono">₹{stats.earnings}</span></div>
                    </div>
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2 font-display border-b border-white/10 pb-2"><History size={18} className="text-cyan-500"/> MISSION LOG</h3>
                    <div className="space-y-3">
                        {myTournaments.length === 0 ? (<div className="text-center py-12 border border-dashed border-slate-800 rounded-2xl bg-slate-900/30 text-slate-500 text-sm font-mono">NO COMBAT DATA FOUND.</div>) : (myTournaments.map(t => {
                            const myData = t.participants.find(p => p.userId === userId);
                            const isWinner = t.status === 'completed' && t.winner === myData.inGameName;
                            return (
                                <div key={t.id} className={`p-4 rounded-xl border flex justify-between items-center transition-all hover:translate-x-1 ${isWinner ? 'bg-yellow-500/5 border-yellow-500/20' : 'bg-slate-900/50 border-slate-800'}`}>
                                    <div><div className="flex gap-2 mb-1"><span className="text-[10px] bg-slate-950 border border-slate-700 text-slate-400 px-1.5 py-0.5 rounded font-bold uppercase tracking-wider">{t.game}</span><span className="text-[10px] text-slate-500 font-mono">{formatDate(t.dateTime)}</span></div><div className="font-bold text-white text-sm font-display">{t.title}</div></div>
                                    <div className="text-right"><div className={`text-xs font-black ${isWinner ? 'text-yellow-400' : 'text-slate-400'} font-display tracking-wider`}>{isWinner ? 'VICTORY' : 'DEFEAT'}</div>{isWinner && <div className="text-xs text-yellow-500 font-bold font-mono">+₹{t.prizePool}</div>}</div>
                                </div>
                            );
                        }))}
                    </div>
                </div>
            );
        }

        // --- NEW FAQ COMPONENT ---
        const FAQSection = () => {
            const faqs = [
                { q: "What is Ring's of Fire?", a: "Ring's of Fire is a premier competitive esports platform. We host daily high-stakes lobbies for games like Free Fire and BGMI, offering a secure arena for players to compete and earn real cash rewards." },
                { q: "Is it safe to use?", a: "Operational security is paramount. We utilize advanced encryption for data protection and enforce strict fair-play algorithms to ensure a secure and equitable battleground for all operatives." },
                { q: "Is my money safe?", a: "Affirmative. Your funds are secured in a protected vault. Winnings are processed and dispatched to your designated account within 24 hours of mission success verification." },
                { q: "How to request a refund?", a: "For transaction disputes or refund requests, establish a direct line with our command team via Telegram. Message an Admin for immediate resolution protocols." }
            ];

            return (
                <div className="mt-16 animate-fade-in border-t border-slate-800 pt-12">
                    <h3 className="text-2xl font-black text-white mb-8 font-display text-center tracking-wider"><span className="text-cyan-500">SYSTEM</span> INTEL</h3>
                    <div className="grid md:grid-cols-2 gap-4 mb-12">
                        {faqs.map((f, i) => (
                            <div key={i} className="glass-card p-6 rounded-xl border border-slate-700/50 hover:border-cyan-500/30 transition-all group">
                                <div className="flex items-start gap-4">
                                    <div className="bg-cyan-500/10 p-2.5 rounded-lg text-cyan-400 shrink-0 group-hover:scale-110 transition-transform"><Info size={20}/></div>
                                    <div>
                                        <h4 className="font-bold text-white text-sm mb-2 font-display uppercase tracking-wide group-hover:text-cyan-400 transition-colors">{f.q}</h4>
                                        <p className="text-slate-400 text-xs leading-relaxed font-mono">{f.a}</p>
                                    </div>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    <div className="border-t border-slate-800 pt-10 pb-6 text-center bg-gradient-to-t from-slate-900/50 to-transparent rounded-b-3xl">
                        <h4 className="text-white font-bold mb-6 font-display text-sm tracking-widest">ESTABLISH COMMS</h4>
                        <div className="flex flex-wrap justify-center gap-4 md:gap-6 mb-10 px-4">
                            <a href="https://www.instagram.com/rings.of.fire.offical?igsh=MXBtY3hjbGFob3BicQ==" target="_blank" className="group relative">
                                <div className="absolute inset-0 bg-pink-600 blur-xl opacity-20 group-hover:opacity-40 transition-opacity rounded-2xl"></div>
                                <div className="relative bg-slate-950 border border-slate-700 p-4 md:p-6 rounded-2xl group-hover:border-pink-500/50 transition-all flex flex-col items-center gap-2 min-w-[120px] md:min-w-[140px] transform group-hover:-translate-y-1">
                                    <Instagram size={28} className="text-pink-500 mb-1"/>
                                    <span className="text-[10px] md:text-xs font-bold text-slate-300 uppercase tracking-widest group-hover:text-white transition-colors">Instagram</span>
                                </div>
                            </a>
                            <a href="https://t.me/ringsoffire1" target="_blank" className="group relative">
                                <div className="absolute inset-0 bg-blue-600 blur-xl opacity-20 group-hover:opacity-40 transition-opacity rounded-2xl"></div>
                                <div className="relative bg-slate-950 border border-slate-700 p-4 md:p-6 rounded-2xl group-hover:border-blue-500/50 transition-all flex flex-col items-center gap-2 min-w-[120px] md:min-w-[140px] transform group-hover:-translate-y-1">
                                    <Send size={28} className="text-blue-500 mb-1"/>
                                    <span className="text-[10px] md:text-xs font-bold text-slate-300 uppercase tracking-widest group-hover:text-white transition-colors">Telegram</span>
                                </div>
                            </a>
                        </div>
                        <div className="text-slate-600 text-[10px] font-mono uppercase tracking-widest flex flex-col items-center gap-2 opacity-60 hover:opacity-100 transition-opacity">
                            <div className="w-16 h-0.5 bg-gradient-to-r from-transparent via-cyan-900 to-transparent mb-2"></div>
                            <span>&copy; 2025 Ring's of Fire Pvt Ltd.</span>
                            <span>All Rights Reserved. System Version 2.0</span>
                        </div>
                    </div>
                </div>
            );
        };

        function RoleSelection({ onSelect, authError, onGuestLogin, setShowAdminLogin }) {
            return (
                <div className="flex flex-col items-center justify-center min-h-[70vh] relative animate-fade-in">
                    <div className="text-center mb-12 relative z-10">
                        <div className="inline-flex items-center justify-center w-20 h-20 bg-cyan-500/10 rounded-full mb-6 border border-cyan-500/30 animate-pulse-fast"><Flame size={40} className="text-cyan-400 drop-shadow-[0_0_10px_cyan]" /></div>
                        <h1 className="text-5xl md:text-7xl font-black text-white mb-2 glitch-text font-display tracking-tight" data-text="RING'S OF FIRE">RING'S OF FIRE</h1>
                        <p className="text-slate-400 font-mono tracking-widest text-sm md:text-base uppercase">The Ultimate Digital Battleground</p>
                    </div>
                    <div className="grid md:grid-cols-2 gap-6 w-full max-w-4xl relative z-10 px-4">
                        <button onClick={onGuestLogin} className="group relative h-64 glass-card rounded-2xl p-8 text-left hover:-translate-y-2 transition-all duration-500 border-l-4 border-l-cyan-500 hover:bg-cyan-950/30">
                            <div className="corner-bracket border-t-2 border-l-2 top-4 left-4"></div><div className="corner-bracket border-t-2 border-r-2 top-4 right-4"></div><div className="corner-bracket border-b-2 border-l-2 bottom-4 left-4"></div><div className="corner-bracket border-b-2 border-r-2 bottom-4 right-4"></div>
                            <div className="absolute inset-0 bg-gradient-to-br from-cyan-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                            <Gamepad2 size={80} className="absolute top-4 right-4 text-cyan-500/10 group-hover:text-cyan-500/20 transition-colors rotate-12 group-hover:scale-110 duration-500 pointer-events-none"/>
                            <div className="relative h-full flex flex-col justify-end pointer-events-none"><div className="w-12 h-12 bg-cyan-500/20 rounded-lg flex items-center justify-center mb-4 text-cyan-400 border border-cyan-500/30 group-hover:shadow-[0_0_15px_cyan] transition-all"><Crosshair size={24}/></div><h3 className="text-2xl font-bold text-white font-display mb-1 group-hover:text-cyan-400 transition-colors">PLAYER ZONE</h3><p className="text-slate-400 text-sm font-mono">Enter the arena. Prove your worth.</p></div>
                        </button>
                        <button onClick={() => setShowAdminLogin(true)} className="group relative h-64 glass-card rounded-2xl p-8 text-left hover:-translate-y-2 transition-all duration-500 border-l-4 border-l-violet-500 hover:bg-violet-950/30">
                            <div className="corner-bracket border-t-2 border-l-2 top-4 left-4" style={{borderColor: 'rgba(139,92,246,0.3)'}}></div><div className="corner-bracket border-t-2 border-r-2 top-4 right-4" style={{borderColor: 'rgba(139,92,246,0.3)'}}></div><div className="corner-bracket border-b-2 border-l-2 bottom-4 left-4" style={{borderColor: 'rgba(139,92,246,0.3)'}}></div><div className="corner-bracket border-b-2 border-r-2 bottom-4 right-4" style={{borderColor: 'rgba(139,92,246,0.3)'}}></div>
                            <div className="absolute inset-0 bg-gradient-to-br from-violet-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>
                            <Shield size={80} className="absolute top-4 right-4 text-violet-500/10 group-hover:text-violet-500/20 transition-colors -rotate-6 group-hover:scale-110 duration-500 pointer-events-none"/>
                            <div className="relative h-full flex flex-col justify-end pointer-events-none"><div className="w-12 h-12 bg-violet-500/20 rounded-lg flex items-center justify-center mb-4 text-violet-400 border border-violet-500/30 group-hover:shadow-[0_0_15px_violet] transition-all"><Lock size={24}/></div><h3 className="text-2xl font-bold text-white font-display mb-1 group-hover:text-violet-400 transition-colors">ORGANIZER</h3><p className="text-slate-400 text-sm font-mono">Control the league. Manage chaos.</p></div>
                        </button>
                    </div>
                    
                    {/* FAQ SECTION ADDED HERE FOR LANDING PAGE */}
                    <div className="w-full max-w-4xl px-4 mt-8">
                        <FAQSection />
                    </div>
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(null);
            const [role, setRole] = useState(null);
            const [tournaments, setTournaments] = useState([]);
            const [news, setNews] = useState([]);
            const [notifications, setNotifications] = useState([]);
            const [authError, setAuthError] = useState(null);
            const [showAuthModal, setShowAuthModal] = useState(false);
            const [showAdminLogin, setShowAdminLogin] = useState(false);
            const [view, setView] = useState('home');
            const [selected, setSelected] = useState(null);
            const [gameFilter, setGameFilter] = useState('All');
            const [notification, setNotification] = useState(null);

            const showNotification = (message, type = 'success') => { setNotification({ message, type }); setTimeout(() => setNotification(null), 3000); };

            useEffect(() => {
                if(!app) return;
                const initAuth = async () => {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        try {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } catch (e) {
                            console.warn("Custom token failed, trying anonymous:", e);
                            if (!auth.currentUser) await signInAnonymously(auth).catch(e => console.error("Anon failed", e));
                        }
                    } else if (!auth.currentUser) {
                        await signInAnonymously(auth).catch(e => console.warn("Anon skipped", e));
                    }
                };
                initAuth();

                const unsub = onAuthStateChanged(auth, u => { 
                    setUser(u); 
                    if(u && !u.isAnonymous) setRole('player'); 
                }); 
                return unsub; 
            }, []);

            useEffect(() => {
                if((!user && role!=='guest' && role!=='admin') || !db) return;
                const tRef = getTournamentCollection();
                if(tRef) onSnapshot(tRef, s => setTournaments(s.docs.map(d=>({id:d.id,...d.data()})).sort((a,b) => new Date(a.dateTime)-new Date(b.dateTime))));
                const nRef = getSettingsDoc('news');
                if(nRef) onSnapshot(nRef, s => setNews(s.data()?.items || []));
                const notifRef = getNotificationsCollection();
                if(notifRef) onSnapshot(query(notifRef, where('target','in',['all', role==='admin'?'admin':(user?.uid||'guest')])), s => setNotifications(s.docs.map(d=>d.data()).sort((a,b)=>b.createdAt-a.createdAt).slice(0,10)));
            }, [user, role]);

            useEffect(() => {
                const params = new URLSearchParams(window.location.search);
                const tId = params.get('tournament_id');
                if (tId) { 
                    // Find tournament in state if loaded, or wait
                    if(tournaments.length > 0) {
                        const t = tournaments.find(tour => tour.id === tId);
                        if(t) setSelected(t);
                    }
                    if (!user && !role) setRole('guest'); 
                }
            }, [tournaments, user, role]);

            const filteredTournaments = tournaments.filter(t => {
                if(view === 'past') return t.status === 'completed';
                if(t.status === 'completed') return false;
                if(gameFilter !== 'All') return t.game === gameFilter;
                return true;
            });

            return (
                <div className="min-h-screen relative pb-20">
                    <div className="fixed inset-0 pointer-events-none bg-[radial-gradient(ellipse_at_top,_var(--tw-gradient-stops))] from-cyan-900/20 via-slate-950 to-slate-950 z-0"></div>
                    {notification && (<div className={`fixed top-20 right-4 z-[100] px-4 py-3 rounded-xl shadow-2xl border backdrop-blur-xl flex items-center gap-3 animate-fade-in-down transform transition-all duration-500 ${notification.type === 'success' ? 'bg-emerald-900/90 border-emerald-500/50 text-emerald-100' : 'bg-red-900/90 border-red-500/50 text-red-100'}`}>{notification.type === 'success' ? <CheckCircle size={18} /> : <Shield size={18} />}<span className="font-medium text-sm">{notification.message}</span></div>)}
                    <header className="sticky top-0 z-40 backdrop-blur-md border-b border-white/5 bg-slate-950/80">
                        <div className="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-2 cursor-pointer" onClick={()=>setView('home')}><div className="bg-cyan-500/10 p-1.5 rounded border border-cyan-500/30"><Flame size={20} className="text-cyan-400"/></div><span className="font-display font-bold text-white tracking-wider text-lg hidden md:block">RING'S OF FIRE</span></div>
                            {(role || user) && (
                                <div className="flex items-center gap-4"><NotificationCenter notifications={notifications} />{role !== 'guest' ? <button onClick={() => signOut(auth).then(()=>setRole(null))} className="text-slate-400 hover:text-white"><LogOut size={20}/></button> : <button onClick={()=>setShowAuthModal(true)} className="text-cyan-400 font-bold text-sm hover:underline decoration-cyan-500 underline-offset-4">LOGIN</button>}</div>
                            )}
                        </div>
                        <NewsTicker newsItems={news} />
                    </header>
                    <main className="max-w-7xl mx-auto px-4 py-8 relative z-10">
                        {!role ? (<RoleSelection onSelect={setRole} authError={authError} onGuestLogin={()=>setShowAuthModal(true)} setShowAdminLogin={setShowAdminLogin}/>) : (
                            <>
                                {role !== 'admin' ? (
                                    <>
                                        <div className="flex flex-wrap gap-4 justify-between items-end mb-8 animate-fade-in">
                                            <div><h2 className="text-3xl font-display font-black text-white mb-1 glitch-text" data-text="BATTLEGROUNDS">BATTLEGROUNDS</h2><div className="flex gap-2"><button onClick={()=>setView('home')} className={`text-xs font-bold px-3 py-1 rounded border font-display tracking-wide transition-all ${view==='home'?'bg-cyan-600 border-cyan-500 text-white shadow-[0_0_10px_rgba(6,182,212,0.4)]':'border-slate-700 text-slate-400 hover:text-white hover:border-slate-500'}`}>EVENTS</button><button onClick={()=>setView('past')} className={`text-xs font-bold px-3 py-1 rounded border font-display tracking-wide transition-all ${view==='past'?'bg-cyan-600 border-cyan-500 text-white shadow-[0_0_10px_rgba(6,182,212,0.4)]':'border-slate-700 text-slate-400 hover:text-white hover:border-slate-500'}`}>PAST MATCHES</button>{user && <button onClick={()=>setView('profile')} className={`text-xs font-bold px-3 py-1 rounded border font-display tracking-wide transition-all ${view==='profile'?'bg-cyan-600 border-cyan-500 text-white shadow-[0_0_10px_rgba(6,182,212,0.4)]':'border-slate-700 text-slate-400 hover:text-white hover:border-slate-500'}`}>PROFILE</button>}</div></div>
                                            {view === 'home' && (<div className="flex gap-2 overflow-x-auto custom-scrollbar pb-2">{['All', 'Free Fire', 'BGMI', 'PUBG Mobile'].map(g => (<button key={g} onClick={()=>setGameFilter(g)} className={`whitespace-nowrap px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider transition-all border ${gameFilter===g ? 'bg-cyan-500/20 border-cyan-500 text-cyan-400 shadow-[0_0_10px_rgba(6,182,212,0.3)]' : 'bg-slate-900 border-slate-700 text-slate-500 hover:text-slate-300'}`}>{g}</button>))}</div>)}
                                        </div>
                                        {view === 'profile' ? (<PlayerProfile userId={user?.uid} userEmail={user?.email} tournaments={tournaments} onBack={()=>setView('home')}/>) : (
                                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 animate-fade-in-up">
                                                {filteredTournaments.length === 0 ? (<div className="col-span-full py-20 text-center border-2 border-dashed border-slate-800 rounded-3xl"><Gamepad2 size={48} className="mx-auto text-slate-700 mb-4"/><p className="text-slate-500 font-mono">NO DATA FOUND IN SECTOR</p></div>) : filteredTournaments.map(t => {
                                                    const joined = t.participants?.some(p => p.userId === user?.uid);
                                                    if (view === 'past') {
                                                        return (
                                                            <div key={t.id} className="glass-card rounded-xl overflow-hidden p-6 flex flex-col justify-between h-full group border border-yellow-500/10 hover:border-yellow-500/40 hover:shadow-[0_0_30px_rgba(234,179,8,0.1)] transition-all relative">
                                                                <div className="absolute top-0 right-0 w-32 h-32 bg-yellow-500/10 blur-[60px] rounded-full pointer-events-none group-hover:bg-yellow-500/20 transition-all"></div>
                                                                <div>
                                                                    <div className="flex justify-between items-start mb-4"><span className="text-[10px] font-bold bg-slate-950 border border-slate-700 text-slate-400 px-2 py-1 rounded uppercase tracking-wider">{t.game}</span><span className="text-xs text-slate-500 font-mono">{formatDate(t.dateTime)}</span></div>
                                                                    <h3 className="text-lg font-display font-bold text-white mb-4 truncate">{t.title}</h3>
                                                                    <div className="bg-gradient-to-br from-yellow-900/20 to-transparent border border-yellow-500/20 rounded-xl p-4 text-center relative overflow-hidden group-hover:border-yellow-500/40 transition-colors"><div className="absolute top-2 right-2 opacity-20"><Trophy size={24} className="text-yellow-500"/></div><div className="text-[10px] font-bold text-yellow-600 uppercase mb-1 font-display tracking-widest">VICTOR</div><div className="text-xl font-black text-yellow-400 truncate font-display drop-shadow-sm">{t.winner || "UNDECIDED"}</div></div>
                                                                </div>
                                                                <div className="mt-4 pt-4 border-t border-white/5 text-center flex justify-between items-center px-2"><span className="text-[10px] text-slate-500 uppercase font-bold">Prize Pool</span><span className="text-sm font-bold text-emerald-400 font-mono">₹{t.prizePool}</span></div>
                                                            </div>
                                                        );
                                                    }
                                                    return <PlayerTournamentCard key={t.id} t={t} joined={joined} verified={t.participants?.find(p=>p.userId===user?.uid)?.paymentVerified} slotsLeft={t.totalSlots - (t.participants?.length||0)*(t.format==='Squad'?4:t.format==='Duo'?2:1)} percentFilled={Math.min(100, ((t.participants?.length||0)*(t.format==='Squad'?4:t.format==='Duo'?2:1)/t.totalSlots)*100)} isFull={(t.totalSlots - (t.participants?.length||0)*(t.format==='Squad'?4:t.format==='Duo'?2:1)) <= 0} setSelected={setSelected} />;
                                                })}
                                            </div>
                                        )}
                                        {/* --- NEW FAQ & FOOTER SECTION ADDED TO PLAYER ZONE --- */}
                                        {view === 'home' && <div className="w-full max-w-4xl px-4 mt-8 mx-auto"><FAQSection /></div>}
                                    </>
                                ) : (<AdminPanel tournaments={tournaments} showNotification={showNotification} userId={user?.uid} news={news} />)}
                            </>
                        )}
                    </main>
                    
                    {selected && (
                        <PaymentModal 
                            tournament={selected} 
                            onClose={()=>setSelected(null)} 
                            user={user} 
                            showNotification={showNotification} 
                            onLoginRequest={()=>{ setShowAuthModal(true); }} 
                        />
                    )}

                    {showAuthModal && <PlayerAuthModal onClose={()=>setShowAuthModal(false)} onLogin={()=>{setShowAuthModal(false);setRole('player')}} showNotification={showNotification} />}
                    {showAdminLogin && <AdminLoginModal onClose={()=>setShowAdminLogin(false)} onLogin={()=>{setShowAdminLogin(false);setRole('admin')}} showNotification={showNotification} />}
                    
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
